<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>360 Viewer Ultra-Debug</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: sans-serif; }
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #000; z-index: 1000; color: white;
        }
        button {
            padding: 20px 40px; font-size: 20px; font-weight: bold;
            background: #007bff; color: white; border: none; border-radius: 8px;
            cursor: pointer;
        }
        #status { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #666; font-size: 12px; z-index: 2000; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>360Â° VIEWER</h1>
        <button id="start-btn">CLICCA PER INIZIARE</button>
        <p id="loading-msg">In attesa del click...</p>
    </div>
    <div id="status">Log: Inizializzazione...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/DeviceOrientationControls.js"></script>

    <script>
        var camera, scene, renderer, controls, deviceControls, sphere;
        var log = document.getElementById('status');
        
        function updateLog(msg) { log.innerText = "Log: " + msg; console.log(msg); }

        function init() {
            try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.set(0, 0, 0.1);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.outputEncoding = THREE.sRGBEncoding;
                document.body.appendChild(renderer.domElement);

                var geometry = new THREE.SphereGeometry(500, 60, 40);
                geometry.scale(-1, 1, 1);

                var loader = new THREE.TextureLoader();
                // Tenta di caricare la tua immagine, se fallisce usa quella di test di Three.js
                var imgPath = 'panorama.jpg';
                
                loader.load(imgPath, 
                    function(texture) {
                        applyTexture(texture, "Tua immagine caricata");
                    },
                    undefined,
                    function(err) {
                        updateLog("panorama.jpg non trovata, carico immagine di test...");
                        loader.load('https://threejs.org/examples/textures/2294472375_24a3b8ef46_o.jpg', function(tex) {
                            applyTexture(tex, "Immagine di TEST caricata");
                        });
                    }
                );

                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.rotateSpeed = -0.25;

                window.addEventListener('resize', onWindowResize, false);
                animate();
                updateLog("Sistema pronto. Clicca il tasto blu.");
            } catch(e) {
                updateLog("Errore critico: " + e.message);
            }
        }

        function applyTexture(texture, msg) {
            texture.encoding = THREE.sRGBEncoding;
            var material = new THREE.MeshBasicMaterial({ map: texture });
            sphere = new THREE.Mesh(new THREE.SphereGeometry(500, 60, 40).scale(-1, 1, 1), material);
            scene.add(sphere);
            updateLog(msg);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (deviceControls) deviceControls.update();
            else controls.update();
            renderer.render(scene, camera);
        }

        document.getElementById('start-btn').addEventListener('click', function() {
            updateLog("Tentativo di avvio...");
            document.getElementById('ui').style.display = 'none';

            // Fullscreen
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();

            // Giroscopio
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(function(res) {
                    if (res == 'granted') {
                        deviceControls = new THREE.DeviceOrientationControls(camera);
                        updateLog("Giroscopio ATTIVO");
                    }
                }).catch(function(e) { updateLog("Giroscopio negato"); });
            } else if (window.DeviceOrientationEvent) {
                deviceControls = new THREE.DeviceOrientationControls(camera);
                updateLog("Giroscopio Standard ATTIVO");
            }
        });

        // Avvia inizializzazione subito
        init();
    </script>
</body>
</html>